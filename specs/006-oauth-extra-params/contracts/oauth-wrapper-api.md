# OAuth Wrapper API Contract

**Feature**: OAuth Extra Parameters Support
**Date**: 2025-11-30

## Interface Definition

### OAuthTransportWrapper

**Location**: `internal/oauth/transport_wrapper.go`

**Purpose**: Wraps mcp-go's OAuth handler to inject extra parameters into OAuth URLs without modifying the upstream library.

```go
package oauth

import (
    "net/http"
    "net/url"

    "github.com/mark3labs/mcp-go/client"
)

// OAuthTransportWrapper wraps mcp-go OAuth handler to inject extra params
type OAuthTransportWrapper struct {
    inner       *client.OAuthHandler
    extraParams map[string]string
}

// NewOAuthTransportWrapper creates a new wrapper with extra params
func NewOAuthTransportWrapper(handler *client.OAuthHandler, extraParams map[string]string) *OAuthTransportWrapper

// WrapAuthorizationURL appends extra params to OAuth authorization URL
func (w *OAuthTransportWrapper) WrapAuthorizationURL(baseURL string) string

// WrapTokenRequest adds extra params to token exchange/refresh requests
func (w *OAuthTransportWrapper) WrapTokenRequest(req *http.Request) error
```

## Method Contracts

### NewOAuthTransportWrapper

**Signature**:
```go
func NewOAuthTransportWrapper(handler *client.OAuthHandler, extraParams map[string]string) *OAuthTransportWrapper
```

**Parameters**:
- `handler`: The mcp-go OAuth handler to wrap (MUST NOT be nil)
- `extraParams`: Map of extra parameters to inject (CAN be nil or empty)

**Returns**:
- `*OAuthTransportWrapper`: New wrapper instance

**Behavior**:
- If `extraParams` is nil or empty, wrapper becomes a no-op (passthrough)
- Stores shallow copy of `extraParams` to avoid external modifications
- Does NOT validate params (validation happens at config load time)

**Example**:
```go
handler := &client.OAuthHandler{...}
extraParams := map[string]string{
    "resource": "https://example.com/mcp",
}
wrapper := NewOAuthTransportWrapper(handler, extraParams)
```

---

### WrapAuthorizationURL

**Signature**:
```go
func (w *OAuthTransportWrapper) WrapAuthorizationURL(baseURL string) string
```

**Parameters**:
- `baseURL`: OAuth authorization URL generated by mcp-go

**Returns**:
- `string`: Modified URL with extra params appended to query string

**Behavior**:
1. Parse `baseURL` using `url.Parse()`
2. Extract existing query parameters
3. For each param in `w.extraParams`:
   - Add to query string (preserving existing params)
   - Use `query.Set(key, value)` for proper URL encoding
4. Return modified URL string

**Edge Cases**:
- If `w.extraParams` is empty: return `baseURL` unchanged
- If `baseURL` is malformed: log warning, return `baseURL` unchanged
- If extra param key already exists in URL: extra param takes precedence (overwrites)

**Example**:
```go
baseURL := "https://provider.com/authorize?response_type=code&client_id=abc"
wrapped := wrapper.WrapAuthorizationURL(baseURL)
// Result: "https://provider.com/authorize?response_type=code&client_id=abc&resource=https%3A%2F%2Fexample.com%2Fmcp"
```

---

### WrapTokenRequest

**Signature**:
```go
func (w *OAuthTransportWrapper) WrapTokenRequest(req *http.Request) error
```

**Parameters**:
- `req`: HTTP request for token exchange or refresh (MUST NOT be nil)

**Returns**:
- `error`: Error if request modification fails, nil on success

**Behavior**:
1. Read existing request body (URL-encoded form)
2. Parse form values
3. For each param in `w.extraParams`:
   - Add to form values (preserving existing values)
   - Use proper URL encoding
4. Encode modified form back to request body
5. Update `Content-Length` header

**Edge Cases**:
- If `w.extraParams` is empty: return nil (no-op)
- If request body is empty: create new form with extra params
- If extra param key already exists: extra param takes precedence (overwrites)
- If body read fails: return error without modifying request

**Example**:
```go
req, _ := http.NewRequest("POST", "https://provider.com/token", strings.NewReader("grant_type=authorization_code&code=xyz"))
err := wrapper.WrapTokenRequest(req)
// Request body now includes: "grant_type=authorization_code&code=xyz&resource=https%3A%2F%2Fexample.com%2Fmcp"
```

## Integration Points

### Where Wrapper is Created

**Location**: `internal/oauth/config.go` (to be modified)

```go
func CreateOAuthConfig(cfg *config.OAuthConfig, storage *storage.Manager) (*client.OAuthConfig, map[string]string, error) {
    // ... existing code ...

    // Extract extra params for wrapper
    extraParams := cfg.ExtraParams
    if extraParams == nil {
        extraParams = make(map[string]string) // Empty map for consistency
    }

    return mcpOAuthConfig, extraParams, nil
}
```

### Where Wrapper is Used

**Location**: `internal/transport/http.go` (to be modified)

```go
func CreateOAuthClient(url string, oauthCfg *client.OAuthConfig, extraParams map[string]string) (*client.Client, error) {
    // Create base OAuth handler
    handler := &client.OAuthHandler{
        Config: oauthCfg,
    }

    // Wrap handler if extra params present
    if len(extraParams) > 0 {
        wrapper := oauth.NewOAuthTransportWrapper(handler, extraParams)
        // Use wrapper to intercept OAuth URLs
        // (implementation details depend on mcp-go API)
    }

    // ... rest of client creation ...
}
```

## Thread Safety

**Wrapper State**: Read-only after creation (immutable)
- `inner`: Set once in constructor, never modified
- `extraParams`: Copied in constructor, never modified

**Concurrency**: Safe for concurrent use
- No mutexes needed (stateless read-only operations)
- Multiple goroutines can call wrapper methods simultaneously

## Error Handling

**Errors Returned**:
- `WrapTokenRequest`: Returns error if request body modification fails
- `WrapAuthorizationURL`: Logs error but returns baseURL (graceful degradation)

**Error Types**:
- `fmt.Errorf("failed to read request body: %w", err)` - Body read failure
- `fmt.Errorf("failed to encode form: %w", err)` - Form encoding failure

**Logging**:
- Wrapper logs all parameter injections at DEBUG level
- Sensitive params (non-resource) logged with masked values
- Resource URLs logged in full for debugging

## Testing Contract

### Unit Tests

**File**: `internal/oauth/transport_wrapper_test.go`

**Required Test Cases**:
1. `TestNewOAuthTransportWrapper` - Constructor variants (nil params, empty, populated)
2. `TestWrapAuthorizationURL_NoParams` - Passthrough when empty
3. `TestWrapAuthorizationURL_SingleParam` - RFC 8707 resource param
4. `TestWrapAuthorizationURL_MultipleParams` - Multiple extra params
5. `TestWrapAuthorizationURL_MalformedURL` - Error handling
6. `TestWrapTokenRequest_NoParams` - Passthrough when empty
7. `TestWrapTokenRequest_SingleParam` - Add to existing body
8. `TestWrapTokenRequest_EmptyBody` - Create new body with params
9. `TestWrapTokenRequest_Overwrite` - Extra param overwrites existing key

### Integration Tests

**File**: `internal/server/oauth_extra_params_test.go`

**Required Test Cases**:
1. Mock OAuth server requires `resource` parameter
2. OAuth flow completes successfully with extra params
3. Token refresh includes extra params
4. Backward compatibility: OAuth without extra params still works

## Performance Characteristics

**WrapAuthorizationURL**:
- Time Complexity: O(n) where n = number of extra params
- Space Complexity: O(m) where m = total URL length
- Expected Overhead: <1ms for typical URLs (3-5 params)

**WrapTokenRequest**:
- Time Complexity: O(n + b) where n = params, b = body size
- Space Complexity: O(b + m) where m = modified body size
- Expected Overhead: <2ms for typical requests

## References

- **Data Model**: [data-model.md](../data-model.md)
- **Implementation Plan**: [plan.md](../plan.md)
- **RFC 8707**: https://www.rfc-editor.org/rfc/rfc8707.html
- **mcp-go OAuth**: https://github.com/mark3labs/mcp-go/blob/v0.43.1/client/transport/oauth.go
