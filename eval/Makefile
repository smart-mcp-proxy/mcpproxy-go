# MCP Proxy Evaluation Environment Makefile
SHELL := /bin/bash
.PHONY: help setup start-servers start-registry start-mcpproxy run-eval clean test-connection

# Default target
help: ## Show this help message
	@echo "MCP Proxy Evaluation Environment"
	@echo "================================"
	@echo "Available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

setup: ## Install dependencies and setup environment
	@echo "ğŸ”§ Setting up evaluation environment..."
	uv sync
	@echo "âœ… Setup complete!"

start-registry: ## Start the fake MCP registry server
	@echo "ğŸš€ Starting fake MCP registry on port 8001..."
	uv run mcp-registry &
	@sleep 2
	@echo "ğŸ“¡ Registry server started at http://localhost:8001"

start-servers: ## Verify MCP servers are available via uvx
	@echo "ğŸ² Verifying fake MCP servers are available via uvx..."
	@echo "  âœ“ Dice Roller (uvx mcp-dice)"
	@echo "  âœ“ Weather Service (uvx mcp-weather)"
	@echo "  âœ“ Restaurant Finder (uvx mcp-restaurant)"
	@echo "  âœ“ Calculator (uvx mcp-calculator)"
	@echo "  âœ“ Translator (uvx mcp-translator)"
	@echo "  âœ“ Morse Code (uvx mcp-morse)"
	@echo "  âœ“ Time Service (uvx mcp-time)"
	@echo "  âœ“ Joke Generator (uvx mcp-jokes)"
	@echo "  âœ“ Color Palette (uvx mcp-color)"
	@echo "  âœ“ Random Generator (uvx mcp-random)"
	@echo "âœ… All MCP servers available via stdio!"

start-mcpproxy: ## Start mcpproxy with evaluation config
	@echo "ğŸ”§ Starting mcpproxy with evaluation configuration..."
	@echo "âš ï¸  Make sure to build and configure mcpproxy first:"
	@echo "   cd .. && go build"
	@echo "   pkill mcpproxy || true"
	@echo "   ../mcpproxy --config=eval/configs/mcpproxy_eval.json --log-level=debug --tray=false"

start-all: start-registry start-servers ## Start registry and verify MCP servers
	@echo "ğŸŒŸ All services ready!"
	@echo ""
	@echo "ğŸ” Service Status:"
	@echo "  Registry:     http://localhost:8001/health"
	@echo "  MCP Servers:  Available via stdio (uvx commands)"
	@echo ""
	@echo "ğŸ“‹ Next steps:"
	@echo "  1. Start mcpproxy: make start-mcpproxy"
	@echo "  2. Open ADK web UI: make start-adk-web"

test-connection: ## Test connection to all services
	@echo "ğŸ” Testing service connections..."
	@echo -n "Registry: "
	@curl -s http://localhost:8001/health > /dev/null && echo "âœ… OK" || echo "âŒ Failed"
	@echo -n "mcpproxy: "
	@curl -s http://localhost:8080/health > /dev/null && echo "âœ… OK" || echo "âŒ Not running (start with 'make start-mcpproxy')"

start-adk-web: ## Start ADK web UI for interactive evaluation
	@echo "ğŸŒ Starting ADK web UI..."
	@echo "ğŸ“‹ This will open the web interface for:"
	@echo "  - Interactive agent testing"
	@echo "  - Evaluation case creation"
	@echo "  - Manual annotation and review"
	@mkdir -p eval/adk_agents
	@echo "ğŸ”— Opening: http://localhost:8000"
	adk web eval/adk_agents

run-eval-cli: ## Run evaluation via ADK CLI (for automation)
	@echo "ğŸš€ Running ADK CLI evaluation..."
	@echo "ğŸ“‹ Using saved evaluation sets from ADK web UI"
	@mkdir -p eval/results
	adk eval eval/adk_agents eval/datasets/eval_sets/*.evalset.json --print_detailed_results

test-agent: ## Test ADK agent setup
	@echo "ğŸ§ª Testing ADK agent configuration..."
	cd eval/adk_agents && python test_agent.py

generate-eval-templates: ## Generate evaluation template files
	@echo "ğŸ¯ Generating evaluation templates..."
	@mkdir -p eval/datasets/eval_sets
	@mkdir -p eval/adk_agents
	@echo "ğŸ“ Templates created in eval/datasets/"
	@echo "ğŸ’¡ Use 'make start-adk-web' to create evaluation cases interactively"

show-logs: ## Show mcpproxy logs for debugging
	@echo "ğŸ“œ Recent mcpproxy logs:"
	@tail -20 ~/Library/Logs/mcpproxy/main.log || echo "âŒ Log file not found"

debug-logs: ## Show filtered debug logs
	@echo "ğŸ” Showing debug logs (filtered)..."
	@echo "Run this command to monitor in real-time:"
	@echo "tail -f ~/Library/Logs/mcpproxy/main.log | grep -E '(error|fail|success|quarantine|registry)'"

stop-all: ## Stop all running services
	@echo "ğŸ›‘ Stopping all services..."
	@pkill -f "mcp-registry" || true
	@pkill -f "uvicorn.*8001" || true
	@echo "âœ… Registry stopped!"
	@echo "â„¹ï¸  MCP servers run on-demand via stdio (no persistent processes to stop)"

clean: stop-all ## Clean up everything and reset environment
	@echo "ğŸ§¹ Cleaning up evaluation environment..."
	@rm -rf eval/results/*
	@rm -rf eval/datasets/scenarios/*.json
	@echo "âœ… Environment cleaned!"

check-deps: ## Check if all dependencies are available
	@echo "ğŸ” Checking dependencies..."
	@command -v uv >/dev/null 2>&1 || (echo "âŒ uv not found. Install with: curl -LsSf https://astral.sh/uv/install.sh | sh" && exit 1)
	@command -v go >/dev/null 2>&1 || (echo "âŒ Go not found. Install from: https://golang.org/" && exit 1)
	@test -f ../mcpproxy || (echo "âŒ mcpproxy binary not found. Run 'cd .. && go build'" && exit 1)
	@echo "âœ… All dependencies available!"

status: ## Show status of all services
	@echo "ğŸ“Š Service Status:"
	@echo "=================="
	@echo -n "ğŸ”— Registry (8001): "
	@curl -s http://localhost:8001/health >/dev/null && echo "âœ… Running" || echo "âŒ Stopped"
	@echo -n "ğŸ”§ mcpproxy (8080): "
	@curl -s http://localhost:8080/health >/dev/null && echo "âœ… Running" || echo "âŒ Stopped"
	@echo ""
	@echo "ğŸ² MCP Servers (stdio mode):"
	@echo "  All servers available via uvx commands âœ…"

# Development targets
dev-setup: ## Setup development environment with hot reload
	@echo "ğŸ”¥ Setting up development environment..."
	uv sync --dev
	@echo "âœ… Development environment ready!"

dev-test: ## Run development tests
	@echo "ğŸ§ª Running tests..."
	uv run pytest tests/ -v
	@echo "âœ… Tests completed!"

# Complete workflow
full-eval: check-deps setup start-all test-connection start-adk-web ## Complete evaluation workflow setup
	@echo "ğŸ‰ Complete evaluation environment ready!"
	@echo "ğŸŒ ADK web UI should be opening for interactive evaluation"

# Help text
help-scenarios: ## Show detailed scenario descriptions
	@echo "ğŸ“‹ Evaluation Scenarios:"
	@echo "======================="
	@echo ""
	@echo "ğŸ¯ Scenario 1: Adding Server with Quarantine"
	@echo "  Tests agent's ability to:"
	@echo "  - Add upstream MCP servers"
	@echo "  - Handle server addition failures"
	@echo "  - Debug issues using log tailing"
	@echo "  - Generate security reports for quarantined servers"
	@echo ""
	@echo "ğŸ¯ Scenario 2: Search and Add Server"
	@echo "  Tests agent's ability to:"
	@echo "  - List available registries"
	@echo "  - Search for servers by capability"
	@echo "  - Select appropriate server from results"
	@echo "  - Add server found in search results"
	@echo ""
	@echo "ğŸŒ ADK Web UI Workflow:"
	@echo "  1. Start services: make start-all"
	@echo "  2. Start mcpproxy: make start-mcpproxy"
	@echo "  3. Open ADK web UI: make start-adk-web"
	@echo "  4. Interact with agent to create sessions"
	@echo "  5. Save sessions as evaluation cases"
	@echo "  6. Run evaluations with custom metrics"
	@echo ""
	@echo "ğŸ”§ Configuration:"
	@echo "  - Registry URL: http://localhost:8001"
	@echo "  - mcpproxy URL: http://localhost:8080"
	@echo "  - MCP Servers: Available via stdio (uvx commands)" 