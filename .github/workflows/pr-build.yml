name: PR Build

on:
  pull_request:
    branches:
      - "*"
  workflow_dispatch:

jobs:
  prepare:
    name: Prepare Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      clean_version: ${{ steps.version.outputs.clean_version }}
      latest_tag: ${{ steps.version.outputs.latest_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate PR version
        id: version
        shell: bash
        env:
          PR_NUMBER: ${{ github.event.number }}
        run: |
          set -eo pipefail

          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          COMMIT_HASH=$(git rev-parse --short HEAD)

          if [ -n "${PR_NUMBER}" ]; then
            VERSION="${LATEST_TAG}-dev-${COMMIT_HASH}-pr${PR_NUMBER}"
          else
            VERSION="${LATEST_TAG}-dev-${COMMIT_HASH}"
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "clean_version=${VERSION#v}" >> "$GITHUB_OUTPUT"
          echo "latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
          echo "Generated version: ${VERSION}"

  build:
    name: Build Binaries
    needs: prepare
    runs-on: ${{ matrix.os }}
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            cgo: "0"
            name: mcpproxy-linux-amd64
            archive_format: tar.gz
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            cgo: "0"
            name: mcpproxy-linux-arm64
            archive_format: tar.gz
          - os: windows-latest
            goos: windows
            goarch: amd64
            cgo: "1"
            name: mcpproxy-windows-amd64.exe
            archive_format: zip
          - os: windows-latest
            goos: windows
            goarch: arm64
            cgo: "1"
            name: mcpproxy-windows-arm64.exe
            archive_format: zip
          - os: macos-14
            goos: darwin
            goarch: amd64
            cgo: "1"
            name: mcpproxy-darwin-amd64
            archive_format: tar.gz
          - os: macos-14
            goos: darwin
            goarch: arm64
            cgo: "1"
            name: mcpproxy-darwin-arm64
            archive_format: tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.10"
          cache: false  # Disable built-in cache to use explicit cache step below

      - name: Clean Go module cache (macOS workaround)
        if: runner.os == 'macOS'
        run: |
          # Remove potentially corrupted toolchain files
          rm -rf ~/go/pkg/mod/golang.org/toolchain* || true

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Copy frontend dist for embedding
        shell: bash
        run: |
          rm -rf web/frontend
          mkdir -p web/frontend
          cp -r frontend/dist web/frontend/

      - name: Run tests (skip binary E2E tests - not compatible with cross-compilation)
        # Skip tests for Windows ARM64 (cross-compilation - can't run ARM64 binaries on AMD64 runner)
        if: '!(matrix.goos == ''windows'' && matrix.goarch == ''arm64'')'
        run: go test -tags nogui -v -skip "E2E|Binary|MCPProtocol" ./...

      - name: Build binary and create archives
        shell: bash
        env:
          CGO_ENABLED: ${{ matrix.cgo }}
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ env.VERSION }}
          # ✅ Force minimum supported macOS version for compatibility
          MACOSX_DEPLOYMENT_TARGET: "12.0"
          # Defensive CGO flags to ensure proper deployment target
          CGO_CFLAGS: "-mmacosx-version-min=12.0"
          CGO_LDFLAGS: "-mmacosx-version-min=12.0"
        run: |
          LDFLAGS="-s -w -X mcpproxy-go/cmd/mcpproxy.version=${VERSION} -X main.version=${VERSION}"

          # Determine clean binary name
          if [ "${{ matrix.goos }}" = "windows" ]; then
            CLEAN_BINARY="mcpproxy.exe"
          else
            CLEAN_BINARY="mcpproxy"
          fi

          # Create clean core binary for archive
          go build -ldflags "${LDFLAGS}" -o ${CLEAN_BINARY} ./cmd/mcpproxy

          # Build tray binary for platforms with GUI support (macOS and Windows)
          if [ "${{ matrix.goos }}" = "darwin" ] || [ "${{ matrix.goos }}" = "windows" ]; then
            echo "Building mcpproxy-tray for ${{ matrix.goos }}..."

            # Determine tray binary name
            if [ "${{ matrix.goos }}" = "windows" ]; then
              TRAY_BINARY="mcpproxy-tray.exe"
            else
              TRAY_BINARY="mcpproxy-tray"
            fi

            go build -ldflags "${LDFLAGS}" -o ${TRAY_BINARY} ./cmd/mcpproxy-tray
          fi

          # Ad-hoc sign macOS binaries (development only)
          if [ "${{ matrix.goos }}" = "darwin" ]; then
            echo "Ad-hoc signing macOS binaries for development..."
            codesign --force --deep --sign - --identifier "com.smartmcpproxy.mcpproxy.dev" ${CLEAN_BINARY}
            codesign --force --deep --sign - --identifier "com.smartmcpproxy.mcpproxy-tray.dev" mcpproxy-tray

            # Verify signing
            codesign --verify --verbose ${CLEAN_BINARY}
            codesign --verify --verbose mcpproxy-tray
            echo "Binaries signed successfully (development)"
          fi

          # Create archive with version info
          ARCHIVE_BASE="mcpproxy-${VERSION#v}-${{ matrix.goos }}-${{ matrix.goarch }}"

          # Determine files to include in archive
          FILES_TO_ARCHIVE="${CLEAN_BINARY}"

          # Add tray binary if it exists (Windows and macOS)
          if [ "${{ matrix.goos }}" = "windows" ] && [ -f "mcpproxy-tray.exe" ]; then
            FILES_TO_ARCHIVE="${FILES_TO_ARCHIVE} mcpproxy-tray.exe"
            echo "Including mcpproxy-tray.exe in archive"
          elif [ "${{ matrix.goos }}" = "darwin" ] && [ -f "mcpproxy-tray" ]; then
            FILES_TO_ARCHIVE="${FILES_TO_ARCHIVE} mcpproxy-tray"
            echo "Including mcpproxy-tray in archive"
          fi

          if [ "${{ matrix.archive_format }}" = "zip" ]; then
            # Create ZIP archive (Windows)
            # Use PowerShell Compress-Archive on Windows since zip command isn't available
            if [ "${{ matrix.goos }}" = "windows" ]; then
              # Convert space-separated list to comma-separated for PowerShell
              PS_FILES=$(echo ${FILES_TO_ARCHIVE} | sed 's/ /,/g')
              powershell -Command "Compress-Archive -Path ${PS_FILES} -DestinationPath '${ARCHIVE_BASE}.zip'"
            else
              zip "${ARCHIVE_BASE}.zip" ${FILES_TO_ARCHIVE}
            fi
          else
            # Create tar.gz archive (Unix)
            tar -czf "${ARCHIVE_BASE}.tar.gz" ${FILES_TO_ARCHIVE}
          fi

      - name: Create .icns icon (macOS)
        if: matrix.goos == 'darwin'
        run: |
          chmod +x scripts/create-icns.sh
          ./scripts/create-icns.sh

      - name: Create app bundle and DMG installer (macOS)
        if: matrix.goos == 'darwin'
        env:
          VERSION: ${{ env.VERSION }}
          # Ensure DMG creation also uses correct deployment target
          MACOSX_DEPLOYMENT_TARGET: "12.0"
          CGO_CFLAGS: "-mmacosx-version-min=12.0"
          CGO_LDFLAGS: "-mmacosx-version-min=12.0"
        run: |
          chmod +x scripts/create-pkg.sh
          chmod +x scripts/create-app-dmg.sh

          # Set up ad-hoc signing for PR builds
          echo "=== Creating app bundle and DMG for PR build (ad-hoc signed) ==="

          # Determine binary names
          TRAY_BINARY="mcpproxy-tray"
          CORE_BINARY="mcpproxy"

          # Create app bundle using create-pkg.sh in adhoc mode
          # This creates the app bundle but skips PKG creation
          export APP_CERT_IDENTITY=""  # Empty = ad-hoc signing for app bundle
          export PKG_CERT_IDENTITY="adhoc"  # Skip PKG creation, just create app bundle

          # Create app bundle
          ./scripts/create-pkg.sh ${TRAY_BINARY} ${CORE_BINARY} ${VERSION} ${{ matrix.goarch }}

          # App bundle is created at pkg_temp/pkg_root/Applications/mcpproxy.app
          APP_BUNDLE_PATH="pkg_temp/pkg_root/Applications/mcpproxy.app"

          if [ -d "$APP_BUNDLE_PATH" ]; then
            echo "✅ App bundle created successfully"

            # Create DMG containing the app bundle (with Applications symlink for drag-and-drop)
            ./scripts/create-app-dmg.sh "$APP_BUNDLE_PATH" ${VERSION} ${{ matrix.goarch }}

            # Clean up temp directory now that DMG is created
            rm -rf pkg_temp

            echo "✅ Installer DMG created successfully (ad-hoc signed, for testing)"
          else
            echo "❌ App bundle creation failed"
            exit 1
          fi

      - name: Skip notarization (PR Build)
        if: matrix.goos == 'darwin'
        run: |
          echo "Skipping notarization for PR build - this is a development build"
          echo "Production builds go through full notarization in release workflow"

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: archive-${{ matrix.goos }}-${{ matrix.goarch }}
          path: mcpproxy-*-${{ matrix.goos }}-${{ matrix.goarch }}.${{ matrix.archive_format }}
          retention-days: 14

      - name: Upload macOS installer DMG
        if: matrix.goos == 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: installer-dmg-${{ matrix.goos }}-${{ matrix.goarch }}
          path: mcpproxy-*-darwin-${{ matrix.goarch }}-installer.dmg
          retention-days: 14
          if-no-files-found: warn

  announce:
    name: Share Artifacts
    needs:
      - prepare
      - build
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      CLEAN_VERSION: ${{ needs.prepare.outputs.clean_version }}
      LATEST_TAG: ${{ needs.prepare.outputs.latest_tag }}
      RETENTION_DAYS: "14"
    steps:
      - name: Publish artifact summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              core.info('No pull request context; skipping comment.');
              return;
            }

            const runId = context.runId;
            const artifacts = await github.paginate(
              github.rest.actions.listWorkflowRunArtifacts,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId,
                per_page: 100
              }
            );

            if (artifacts.length === 0) {
              core.info('No artifacts found for this run.');
              return;
            }

            const formatSize = (bytes) => {
              if (!bytes) {
                return '0 B';
              }
              const units = ['B', 'KB', 'MB', 'GB'];
              const exponent = Math.min(units.length - 1, Math.floor(Math.log(bytes) / Math.log(1024)));
              const value = bytes / Math.pow(1024, exponent);
              return `${value.toFixed(value >= 10 || exponent === 0 ? 0 : 1)} ${units[exponent]}`;
            };

            const artifactLines = artifacts.map((artifact) => {
              const size = formatSize(artifact.size_in_bytes);
              return `- [${artifact.name}](${artifact.archive_download_url}) -> ${size}`;
            });

            const tableRows = artifacts
              .map((artifact) => `| ${artifact.name} | ${formatSize(artifact.size_in_bytes)} | [Download](${artifact.archive_download_url}) |`)
              .join('\n');

            await core.summary
              .addHeading('Pull Request Artifacts')
              .addRaw(`| Name | Size | Link |\n| --- | --- | --- |\n${tableRows}`, true)
              .addRaw(`\n\nVersion: ${process.env.VERSION}`)
              .addRaw(`\nLatest tag: ${process.env.LATEST_TAG}`)
              .addRaw(`\nLinks expire in ${process.env.RETENTION_DAYS} days.`)
              .write();

            const marker = '<!-- mcpproxy-pr-artifacts -->';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const bodyLines = [
              marker,
              `## 📦 Build Artifacts for PR #${prNumber}`,
              '',
              `**Version:** \`${process.env.VERSION}\``,
              `**Latest tag:** \`${process.env.LATEST_TAG}\``,
              '',
              '### Available Artifacts',
              '',
              ...artifacts.map((artifact) => {
                const size = formatSize(artifact.size_in_bytes);
                return `- **${artifact.name}** (${size})`;
              }),
              '',
              '### How to Download',
              '',
              '**Option 1: GitHub Web UI** (easiest)',
              `1. Go to the [workflow run page](${runUrl})`,
              '2. Scroll to the bottom "Artifacts" section',
              '3. Click on the artifact you want to download',
              '',
              '**Option 2: GitHub CLI**',
              '```bash',
              `gh run download ${runId} --repo ${context.repo.owner}/${context.repo.repo}`,
              '',
              '# Or download a specific artifact:',
              `gh run download ${runId} --name dmg-darwin-arm64`,
              '```',
              '',
              `> **Note:** Artifacts expire in ${process.env.RETENTION_DAYS} days.`
            ];
            const body = bodyLines.join('\n');

            const existingComments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              }
            );

            const previous = existingComments.find(
              (comment) =>
                comment.user?.login === 'github-actions[bot]' &&
                comment.body?.includes(marker)
            );

            if (previous) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: previous.id,
                body
              });
              core.info(`Updated existing artifact comment (${previous.id}).`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
              core.info('Created new artifact comment.');
            }
